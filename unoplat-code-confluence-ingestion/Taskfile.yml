version: "3"

tasks:
  check-temporal-port:
    cmds:
      - |
        if ! lsof -i:8080 > /dev/null 2>&1; then
          echo "Port 8080 is available"
          exit 0
        else
          echo "Port 8080 is already in use"
          exit 1
        fi
    silent: true

  start-temporal:
    deps: [check-temporal-port]
    cmds:
      # Run temporal server in background using &
      - temporal server start-dev --ui-port 8080

  sync:
    desc: Setup project with dependencies
    dir: code-confluence-flow-bridge
    cmds:
      - uv sync

  run-dev:
    desc: Run FastAPI application in development mode
    deps: [sync]
    dir: code-confluence-flow-bridge/src/code_confluence_flow_bridge
    cmds:
      - uv run fastapi dev
  dev:
    desc: Install dependencies and run the application
    cmds:
      - task: run-dev

  ensure-scanner-cli:
    desc: Ensure scanner CLI exists in the user's environment
    cmds:
      - |
            SCANNER_DIR="$HOME/.unoplat/repositories/assets"
            SCANNER_JAR="scanner_cli-2.2.8-all.jar"
            SCANNER_URL="https://github.com/archguard/archguard/releases/download/v2.2.8/$SCANNER_JAR"
    
            # Create directory if it doesn't exist
            mkdir -p "$SCANNER_DIR"
    
            # Download scanner CLI if not found
            if [ ! -f "$SCANNER_DIR/$SCANNER_JAR" ]; then
              echo "Downloading Scanner CLI..."
              curl -L -o "$SCANNER_DIR/$SCANNER_JAR" "$SCANNER_URL"
            else
              echo "Scanner CLI already exists."
            fi
    
  generate-test-prerequisites:
    desc: Generate test prerequisites
    deps: [ensure-scanner-cli]
    dir: code-confluence-flow-bridge/tests/test_data/unoplat-code-confluence-cli
    cmds:
      - |
        SCANNER_DIR="$HOME/.unoplat/repositories/assets"
        SCANNER_JAR="scanner_cli-2.2.8-all.jar"
        
        java -jar "$SCANNER_DIR/$SCANNER_JAR" \
          --with-function-code --language=python \
          --output=arrow --output=json \
          --path=unoplat_code_confluence_cli \
          --output-dir=unoplat_code_confluence_cli/ \
          --depth=20


  test:
    desc: Run tests
    deps: [generate-test-prerequisites]
    dir: code-confluence-flow-bridge
    cmds:
      - uv run pytest tests/ -v

  ci-test:
    desc: Run tests in CI mode
    dir: code-confluence-flow-bridge
    cmds:
      - uv run pytest tests/ -v
